#!/usr/bin/env node
/**
 * ARW CLI - NPX Entry Point (WASM-powered)
 *
 * Simple WASM-based CLI for universal compatibility
 */

const path = require('path');
const fs = require('fs');

// Check if WASM module exists
const wasmPath = path.join(__dirname, '..', 'pkg', 'arw_lib.js');
if (!fs.existsSync(wasmPath)) {
  console.error(`
❌ WASM module not found!

The ARW CLI requires the WASM module to be built.

If you're installing from npm, this is a packaging issue.
If you're developing locally, run:

  cd packages/cli
  npm run build:wasm

Report issues: https://github.com/agent-ready-web/agent-ready-web/issues
`);
  process.exit(1);
}

// Import WASM module
const wasm = require(wasmPath);

async function main() {
  const args = process.argv.slice(2);

  // Show help if no arguments
  if (args.length === 0 || args[0] === '--help' || args[0] === '-h') {
    console.log(`
ARW CLI - Agent-Ready Web Command Line Interface

Usage:
  npx @agent-ready-web/cli <command> [options]

Commands:
  validate <file>              Validate an ARW manifest file
  generate [options]           Generate an ARW manifest interactively
  init [options]               Initialize ARW in a project
  build [options]              Build machine-readable views
  scan [dir]                   Scan directory for content
  serve [options]              Start development server
  watch [options]              Watch for changes and rebuild

Options:
  -h, --help                   Show this help message
  -v, --version                Show version information
  --verbose                    Enable verbose output

Examples:
  npx @agent-ready-web/cli validate ./llms.txt
  npx @agent-ready-web/cli generate --interactive
  npx @agent-ready-web/cli init --profile ARW-2
  npx @agent-ready-web/cli build --output ./public
  npx @agent-ready-web/cli serve --port 3000

Documentation:
  https://github.com/agent-ready-web/agent-ready-web
`);
    return 0;
  }

  // Show version
  if (args[0] === '--version' || args[0] === '-v') {
    const version = wasm.get_version_info();
    console.log(`ARW CLI ${version.cli_version}`);
    console.log(`Spec version: ${version.spec_version}`);
    console.log(`Profiles: ${version.supported_profiles.join(', ')}`);
    return 0;
  }

  // For now, WASM CLI has limited command support
  // This is a simplified version - full CLI requires native binary
  console.log(`
⚠️  WASM-based CLI (limited functionality)

The ARW CLI is running in WASM mode with limited command support.
Currently available via JavaScript API:
  - validateManifest(yamlContent)
  - generateManifest(config)

For full CLI functionality, please install the native binary:
  https://github.com/agent-ready-web/agent-ready-web/releases

Alternatively, use the JavaScript API:
  const arw = require('@agent-ready-web/cli');
  const result = await arw.validateManifest(content);
`);

  return 1;
}

main()
  .then(code => process.exit(code))
  .catch(error => {
    console.error('\n❌ Error:', error.message);
    if (process.env.DEBUG) {
      console.error(error.stack);
    }
    console.error('\nFor help, run: npx @agent-ready-web/cli --help');
    console.error('Report issues: https://github.com/agent-ready-web/agent-ready-web/issues\n');
    process.exit(1);
  });
